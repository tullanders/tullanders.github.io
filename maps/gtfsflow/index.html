<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APR (Anders Plugin Ramverk)</title>
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@3.0.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.0.0/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body {
          width: 100vw;
          height: 100vh;
          margin: 0;
        }
    </style>
</head>
<body>
  <div id="map"></div>
    <script>
        const {DeckGL, TripsLayer, FlyToInterpolator} = deck;
let map;

const DATA_URL = "./gtfs.json";
const LOOP_LENGTH = 1900;
let initialViewState = {
  zoom: 4.5,
  longitude: 16.6435,
  latitude: 58.1282,
  pitch: 0,
  bearing: 30,
};

function initMap() {

  const overlay = new deck.MapboxOverlay({});
  map = new DeckGL({
            //mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
            mapStyle: 'https://raw.githubusercontent.com/CartoDB/basemap-styles/master/mapboxgl/dark-matter-nolabels.json',
            initialViewState: initialViewState,
            controller: true,
            onLoad: rotateCamera

  });

  let currentTime = 400;



  const animate = () => {
    currentTime = (currentTime + 0.4) % LOOP_LENGTH;
    console.log(currentTime);
    map.setProps({
      layers: [
        new TripsLayer({
          id: "trips",
          data: DATA_URL,
          getPath: (d) => d.path,
          getTimestamps: (d) => d.timestamps,
          getColor: [191, 255, 0],
          //getColor: (d) => d.color,
          opacity: 1,
          widthMinPixels: 2,
          trailLength: 60,
          currentTime,
          shadowEnabled: false,
          currentTime,
        })
      ]
    });

    window.requestAnimationFrame(animate);

  };
  //animate()
  setTimeout(() => {
    window.requestAnimationFrame(animate);
}, 1000);

  //overlay.setMap(map);
}


  initMap();
/*
map.setProps({
  viewState: {
              zoom: 4,
                longitude: 18.6435,
                latitude: 63.1282,
                pitch: 100,
            },
            transitionInterpolator: new FlyToInterpolator({speed: 2}),
            transitionDuration: 'auto'
});*/

function rotateCamera() {
  initialViewState = {
    ...initialViewState,
    bearing: 0,
    transitionDuration: 10000,
    zoom:5.3,
    pitch: 90,
    latitude: 60.1282,
    transitionInterpolator: new FlyToInterpolator(['bearing']),
    onTransitionEnd: rotateCamera2
  };
  map.setProps({initialViewState});
}
function rotateCamera2() {
  initialViewState = {
    ...initialViewState,
    bearing: 0,
    longitude: 14,
    transitionDuration: 30000,
    zoom:5.5,

    transitionInterpolator: new FlyToInterpolator(['bearing']),

  };
  map.setProps({initialViewState});
}


    </script>

</body>
</html>
